---
title: "Analyze Chromatin local QTL results"
author: Anna L Tyler
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document:
    code_folding: hide
    collapsed: no
    toc: yes
    toc_float: yes
---

## Introduction

The purpose of this workflow is to analyze the results from 2.1_chromaprobs.Rmd
That workflow imputed local chromatin states for each transcript, and scanned
those states for effects on transcription in the DO.

This workflow compares the eQTL mapped to chromatin and to haplotypes.
  
```{r load_libraries, message = FALSE, warning = FALSE, error = FALSE}
library(here);library(qtl2);library(gprofiler2)
```

```{r source_code}
is.interactive = FALSE
#is.interactive = TRUE
all.code.dir <- list.files(here("Code"), full.names = TRUE)
for(i in 1:length(all.code.dir)){
	all.fun <- list.files(all.code.dir[i], full.names = TRUE)
	for(j in 1:length(all.fun)){source(all.fun[j])}
}
data(CCcolors)
chrom.colors <- colors.from.values(1:8, use.pheatmap.colors = TRUE)
```


## Load data

```{r load_data}
transcript.info <- readRDS(here("Data", "RNASeq", "RNASeq_gene_info.RData"))
ch.coef <- readRDS(here("Results", "chQTL", "chQTL.coef.RDS"))
ch.lod <- readRDS(here("Results", "chQTL", "chQTL.lod.RDS"))
ch.r2 <- readRDS(here("Results", "chQTL", "chQTL.R2.RDS"))
e.coef <- readRDS(here("Results", "eQTL", "eQTL.coef.RDS"))
e.lod <- readRDS(here("Results", "eQTL", "eQTL.lod.RDS"))
e.r2 <- readRDS(here("Results", "eQTL", "eQTL.R2.RDS"))

chrom.mats <- readRDS(here("Results", "ChromHMM", "008_states_C", "Chromatin_States_8_full_gene_1000.RData"))
gene.names <- transcript.info[match(rownames(e.lod), transcript.info[,"ensembl_gene_id"]),"external_gene_name"]
```

## Genetic and Chromatin eQTL LOD score comparison

The following plot compares the maximum LOD score from each chromatin 
eQTL to the LOD scores from the cis genetic haplotypes. In all cases, the
chromatin LOD scores are either the same as the eQTL LOD scores or less.
There are no instances where the chromatin explains the expression better
than the genetics.

```{r max_lod}
max.ch.lod <- sapply(ch.lod, function(x) max(x, na.rm = TRUE))
plot(e.lod, max.ch.lod, xlab = "eQTL LOD score", 
ylab = "Maximum Chromatin eQTL LOD Score")
abline(0,1)
plot(e.lod, max.ch.lod, xlab = "eQTL LOD score", 
ylab = "Maximum Chromatin eQTL LOD Score", log = "xy")
abline(0,1)
```

## Genetic and Chromatin R2 Comparison

We also calculated the R2 for each linear model using either haplotype
probabilities or chromatin probabilities plus covariates to explain 
transcript level. This way we can get a better sense of how much variance
in the expression each type of data is explaining.

```{r max_r2}
max.ch.r2 <- sapply(ch.r2, function(x) max(x, na.rm = TRUE))
r2.diff <- geno.r2 - max.ch.r2
pt.col <- rep("gray", length(r2.diff))
pt.col[which(r2.diff < 0)] <- "red"
plot(e.r2, max.ch.r2, xlab = "eQTL R2", 
ylab = "Maximum Chromatin eQTL R2", col = pt.col, pch = 16)
abline(0,1)
```

The following plot shows the distribution of the difference in R2 between 
the genetic eQTL and the chromatin eQTL. 

```{r lod_diff}
r2.diff <- e.r2-max.ch.r2
hist(r2.diff, breaks = 100)
better.chrom.locale <- which(e.r2-max.ch.r2 < 0)
better.chrom.r2.names <- gene.names[better.chrom.locale]
better.chrom.r2 <- e.r2[better.chrom.locale]
better.chrom.ch.r2 <- max.ch.r2[better.chrom.locale]
```

There are other genes whose LOD scores from the genetics and the chromatin
are vastly different. There can still be a big signal from the chromatin,
it's just not as big as the genetic signal.

```{r}
big.lod.diff <- 20
big.diff.locale <- which(lod.diff > big.lod.diff)
big.diff.chrom.lod.names <- gene.names[big.diff.locale]
big.diff.chrom.lod <- e.lod[big.diff.locale]
big.diff.chrom.ch.lod <- max.ch.lod[big.diff.locale]

#plot(big.diff.chrom.lod, big.diff.chrom.ch.lod)
#abline(0,2)
#enrich <- gost(big.diff.chrom.lod.names, organism = "mmusculus")
#plot.enrichment(enrich, order.by = "p_value", num.terms = 30)
```

## Positional Chromatin LOD score

We normalized the transcript position to examine whether high LOD
scores occurred mostly at the TSS, or at other regions.

It actually appears that there is a dip in average LOD score right
at the TSS, and a peak in average LOD score in the initial part of 
the gene after the TSS.

```{r norm_lod}
test.idx <- 1:length(ch.lod)
#test.idx <- big.diff.locale

norm.ch <- vector(mode = "list", length = length(ch.lod[test.idx]))
names(norm.ch) <- rownames(e.lod)[test.idx]
for(x in 1:length(test.idx)){
  if(is.interactive){report.progress(x, length(test.idx))}
  if(!is.null(ch.lod[[x]])){
  norm.ch[[x]] <- center.on.feature(gene.names[x], transcript.info, ch.lod[[x]][,1], 
  feature = "full")
  }
}

lod.by.pos <- plot.centered.vals(norm.ch, seq.by = 0.01, min.representation = 10, 
ylim = c(0, 10), plot.label = "Mean LOD Score by Position", 
ylab = "Mean LOD Score", return.means = FALSE)
abline(v = c(0,1))
```

We binned the genes by LOD score, and plotted the same curve as
above for each bin. The plot below shows that genes across the 
range of LOD scores all have this dip in LOD score at the TSS.
The color indicates the maximum lod score of the group of genes. 
(red for higher LOD scores, blue for lower LOD scores).

```{r lod_pos}
#also look just by high and low LOD score genes
#the pattern is the same for both, except that high LOD 
#score genes have higher LOD scores througout the gene 
#body than low LOD score genes.

lod.thresh = seq(2,100, 2)
lod.bins <- consec.pairs(lod.thresh)
lod.col <- colors.from.values(lod.thresh, use.pheatmap.colors = TRUE)

for(l in nrow(lod.bins):1){
  lod.bin <- which(apply(lod.by.pos, 1, function(x) 
  max(x, na.rm = TRUE) >= lod.bins[l,1] && max(x, na.rm = TRUE) <= lod.bins[l,2]))

  if(l == nrow(lod.bins)){
      plot(as.numeric(colnames(lod.by.pos)), colMeans(lod.by.pos[lod.bin,], 
      na.rm = TRUE), type = "l", ylim = c(0,100), col = lod.col[l],
      ylab = "Mean LOD Score", xlab = "Relative Genomic Position")
  }else{
    if(length(lod.bin) > 10){
      points(as.numeric(colnames(lod.by.pos)), colMeans(lod.by.pos[lod.bin,], 
      na.rm = TRUE), type = "l", col = lod.col[l])
    }
  }
}
abline(v = c(0,1))
```


## Chromatin state coefficients by position {.tabset .tabset-fade .tabset-pills}

In the figures below, we show the average coefficients for each state 
across the gene body. We only include non-zero coefficients. This tells
us the effect of each state at each position when it actually varies
at that position. 

I had done this earlier using all coefficients, and it looked as if state
7 had a dip in effect at the TSS. It does, but only because it is invariant
at the TSS across strains for most genes. We should also have a measure
of presence and variance across the gene body.

The chromatin states have the same directionality biases that we observed
in the inbred strains. For example, states 1 and 2 are negatively associated
with expression, and state 7 is positively associated with expression.

We see *very* similar spatial pattern to that seen in the inbred mice.

State 8 coefficients dip right at the TSS.
State 7 coefficients are high everywhere, but take a dip at the TSS.
  This is a little different from the inbred mice, where the dip seems 
  to occur upstream of the TSS.
State 5 coefficients were high in the body of the gene
State 4 coefficients were pretty close to 0 everywhere
State 3 coefficients took a little dip by the TSS
State 1 and state 2 coefficients were low everywhere, especially near the TSS

```{r norm_coef, results = "asis", fig.width = 10, fig.height = 4}
norm.ch.coef <- ch.coef
names(norm.ch.coef) <- rownames(e.lod)
for(x in 1:length(ch.coef)){
  if(is.interactive){report.progress(x, length(ch.coef))}
  if(!is.null(ch.coef[[x]])){
  norm.pos <- center.on.feature(gene.names[x], transcript.info, ch.coef[[x]][,1], 
  feature = "full")
  rownames(norm.ch.coef[[x]]) <- names(norm.pos)
  }
}


all.state.coef <- vector(mode = "list", length = 8)
names(all.state.coef) <- 1:8
for(s in 1:8){
  if(is.interactive){quartz(width = 10, height = 4)}
  cat("### State", s, "\n")
  norm.state <- lapply(norm.ch.coef, function(x) x[,s])
  non.missing.state <- norm.state
  for(i in 1:length(norm.state)){
    zero.locale <- which(non.missing.state[[i]] == 0)
    if(length(zero.locale) > 0){
      non.missing.state[[i]][zero.locale] <- NA
    }
  }
  all.state.coef[[s]] <- plot.centered.vals(non.missing.state, seq.by = 0.01, min.representation = 10, 
  ylim = c(-0.3, 0.3), plot.label = paste("State", s), 
  ylab = "Mean Non-Zero Coefficient", return.means = FALSE)
  abline(h = 0, v = c(0,1))
  cat("\n\n")
}
```

## Effect size of chromatin does not depend on position {.tabset .tabset-fade .tabset-pills}

Do the dips we see above represent dips toward zero or away from zero?
Below we show the absolute value of the average coefficient to get a better
handle on which states have stronger effects near the TSS, and which states
have weaker effects.

The strength of the effect of state 7 takes a dip at the TSS.
The strength of the effect of state 1 also take a bit of a dip right at
the TSS, but is high on either side.
The average effect of state 4 goes up a bit at the TSS.
States 2, 3, 5, and 8 are all fairly level across the gene.


```{r coef_magnitude, results = "asis", fig.width = 10, fig.height = 4}
all.state.mag <- vector(mode = "list", length = 8)
names(all.state.mag) <- 1:8
for(s in 1:8){
  if(is.interactive){quartz(width = 10, height = 4)}
  cat("### State", s, "\n")
  norm.state <- lapply(norm.ch.coef, function(x) x[,s])
  abs.state <- lapply(norm.state, function(x) if(length(x) > 0){abs(x)}else{NA})
  non.missing.state <- abs.state
  for(i in 1:length(norm.state)){
    zero.locale <- which(non.missing.state[[i]] == 0)
    if(length(zero.locale) > 0){
      non.missing.state[[i]][zero.locale] <- NA
    }
  }
  all.state.mag[[s]] <- plot.centered.vals(non.missing.state, seq.by = 0.01, 
  min.representation = 10, ylim = c(0, 0.5), plot.label = paste("State", s), 
  ylab = "Mean Non-Zero Coefficient Magnitude", return.means = FALSE)
  abline(h = 0, v = c(0,1))
  #abline(h = mean(all.state.mag[[s]], na.rm = TRUE))
  cat("\n\n")
}

cat("### Mean State Effect Size\n")
barplot(sapply(all.state.mag, function(x) mean(x, na.rm = TRUE)), col = chrom.colors,
main = "Mean Effect Magnitude")
cat("\n")
```

## State Variation by Position {.tabset .tabset-fade .tabset-pills}

The figures below show the proportion of the genes at any given 
gene body position that have variation in the given state across
strains. 

What these figures show is that the placement of state 7 is highly 
consistent right at the TSS because there is a dip in variation right 
at that point. Variation then increases later in the body of the gene. 
This is the lowest value seen for any state, suggesting its placement
at the TSS is important to transcription. 

On the other hand, the variation in state 8 goes up at the TSS, suggesting
that it may play a more regulatory role in that position.

Other states are much less conserved relative to the position in the gene
body. States 4, 5, 6 have high variation throught the gene body. 

State 1 is an interesting one. We know from the analysis in the 
inbred animals that its abundance is very low near the TSS and then 
increases as you move toward the TES. However the proportion of genes
with variation in that state across strains decreases as you move toward
the TSS.

```{r state_variance, results = "asis", fig.width = 10, fig.height = 4}
all.state.var <- vector(mode = "list", length = 8)
names(all.state.var) <- 1:8
for(s in 1:8){
  if(is.interactive){quartz(width = 10, height = 4)}
  cat("### State", s, "\n")
  norm.state <- lapply(norm.ch.coef, function(x) x[,s])
  non.missing.state <- norm.state
  for(i in 1:length(norm.state)){
    non.zero.locale <- which(non.missing.state[[i]] != 0)
    if(length(non.zero.locale) > 0){
      non.missing.state[[i]][non.zero.locale] <- 1
    }
  }
  all.state.var[[s]] <- plot.centered.vals(non.missing.state, seq.by = 0.01, 
  min.representation = 10, ylim = c(0, 1.1), plot.label = paste("State", s), 
  ylab = "Proportion Genes With Variation in State", return.means = FALSE)
  abline(h = 0, v = c(0,1))
  cat("\n\n")
}
```

## Genes with variation in state 7 at TSS

We looked at which genes had variation in state 7 at the TSS.

```{r state_seven_tss}
state.seven.var <- all.state.var[[7]]
tss.pt <- get.nearest.pt(as.numeric(colnames(state.seven.var)), 0)
state.var.locale <- which(state.seven.var[,tss.pt] == 1)
var.id <- rownames(state.seven.var)[state.var.locale]
enrich <- gost(var.id, organism = "mmusculus")
plot.enrichment(enrich, order.by = "p_value")
```

## Putting together position, variation, and effect

To assess the involvement of a given chromatin state in regulation of
transcription, we looked at whether the state varied across strains
at each position, what the magnitude of the effect on expression was
at each position, and what the direction of the effect on expression 
was at each position. 

### Magnitude of state effect does not depend on position

All states had consistent magnitude of effect across the gene body.
That is, when they were present, and when there was variation in that
state, the effect did not depend on position in the gene body. There
are lots of wiggles in the lines, but no stark trends. 

```{r testing, eval = FALSE}
s = 8
one.state.coef <- all.state.coef[[s]]
one.state.mag <- all.state.mag[[s]]
one.state.var <- all.state.var[[s]]

common.locale <- Reduce("intersect", list(colnames(one.state.coef), colnames(one.state.mag),
colnames(one.state.var)))
coef.locale <- match(common.locale, colnames(one.state.coef))
mag.locale <- match(common.locale, colnames(one.state.mag))
var.locale <- match(common.locale, colnames(one.state.var))

mean.coef <- colMeans(one.state.coef[,coef.locale], na.rm = TRUE)
mean.var <- colMeans(one.state.var[,var.locale], na.rm = TRUE)
mean.mag <- colMeans(one.state.mag[,mag.locale], na.rm = TRUE)
pairs(cbind(mean.coef, mean.var, mean.mag))
```

### There is low variation in chromatin state at the TSS

There is a dip in LOD score right at the TSS, suggesting that this 
position is not used much to regulate variations in strain-specific
expression. We see that state 7 is very consistently represented at
this position across strains. Where there is variation in this state
at the TSS, it has a positive effect on expression.





State 7 is very consistently represented at the TSS, and has very 
little variation across strains at that position. When state 7 does
vary at the TSS, 

Further on in
the gene body it varies more.