---
title: "Peakome"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document:
    code_folding: hide
    collapsed: no
    toc: yes
    toc_float: yes
---

## Introduction

The purpose of this workflow is to generate a peakome for the 
histone modifications. We can perform an SVD on the peakome
to see how the individuals from each strain cluster based on 
their histone modifications. 

I have downloaded the bed files from 
/projects/carter-lab/hepatocytes/old/results/peakome/narrow_peaks_e5_dba/
I will check with Annat about whether these are good files to use.

I found out that these are not the right files to use, but I learned 
a lot using these files, so I am keeping the code in case it comes
in useful later.

```{r set_args}
args <- commandArgs(trailingOnly=T)
delete.previous = as.logical(args[1]) #whether to delete and regenerate files 
                    #from previous a run.
is.interactive = FALSE
#is.interactive = TRUE

if(is.na(delete.previous)){delete.previous = FALSE}
```

```{r set_param}
library(here)
param <- read.delim(here("Data", "support_files", "param.txt"), header = FALSE, 
    stringsAsFactors = FALSE, row.names = 1)
ordered.marks <- strsplit(param["ordered_marks",], ",")[[1]]
```

```{r source_code}
all.code.dir <- list.files(here("Code"), full.names = TRUE)
for(i in 1:length(all.code.dir)){
	all.fun <- list.files(all.code.dir[i], full.names = TRUE, pattern = ".R")
	for(j in 1:length(all.fun)){source(all.fun[j])}
}
```

```{r load_libraries, message = FALSE, warning = FALSE, error = FALSE}
needed.packages <- c("VennDiagram", "ape", "gprofiler2", 
"e1071", "DESeq2", "knitr", "pheatmap", "hexbin", "RColorBrewer", "MASS", 
"gridExtra", "grid", "ggplotify", "qtl2", "caTools", "stringr")
load_libraries(needed.packages)
```


```{r data}
key.file <- here("Data", "support_files", "strain.color.table.txt") #generated by hand
col.table <- as.matrix(read.table(key.file, sep = "\t", comment.char = "%", 
    stringsAsFactors = FALSE))

peakome.files <- list.files(here("Data", "peakome"), pattern = "peaks")
split.files <- strsplit(peakome.files, "_")
all.marks <- sapply(split.files, function(x) x[1])
all.ind <- sapply(split.files, function(x) strsplit(x[2], ".", fixed = TRUE)[[1]][1])
all.strain <- substr(all.ind, 1, nchar(all.ind)-2)
u_mark <- unique(all.marks)
```

```{bash, remove_name_column, eval = FALSE}
#some files I downloaded had a name column, which merge doesn't like
#this code takes out the fourth column, when it is a name.

bedpath=/Users/atyler/Documents/Projects/Epigenetics/Epigenetics_Manuscript/Data/peakome

for x in $(find "$bedpath" -name '*.bed'); do
    echo ": $x"
    targetfile="${x%bed}noname.bed";
    echo "$targetfile";
    awk 'BEGIN{OFS="\t"}{print $1,$2,$3,$5}' $x > $targetfile
done
```

```{bash, remove_chr, eval = FALSE}
#remove chr from refseq gene coordinates
sed 's/chr//' RefSeqGene.mm10.bed > gene_coords.bed
```


```{r peak_overlap}
#all.noname.files <- list.files(here("Data", "peakome"), pattern = "noname", full.names = TRUE)
all.noname.files <- get.files(here("Data", "peakome"), want = c("peaks"), full.names = TRUE)

chr = 5; start.bp = 104459450; end.bp = 104505819; bp.buffer = 1e5; #Pkd2

sub.tables <- vector(mode = "list", length = length(u_mark))
names(sub.tables) <- u_mark

for(i in 1:length(u_mark)){
    mark.files <- all.noname.files[which(all.marks == u_mark[i])]
    strain <- all.strain[which(all.marks == u_mark[i])]
    strain.col <- col.table[match(strain, col.table[,6]),3]
    sub.tables[[i]] <- plot_bed(bed.files = mark.files, chr, 
        start.bp, end.bp, bp.buffer, col = strain.col, value.col = 4,
        filename = here("Results", "Peakome", paste0("Peaks.", u_mark[i], ".pdf")))
}
```

For each histone modification, merge the peakomes for all individuals
into one bed file.

```{r merge_all.files}
strain.columns <- vector(mode = "list", length = length(u_mark))
names(strain.columns) <- u_mark

for(m in 1:length(u_mark)){
    final.file <- here("Results", "Peakome", paste0("combined.peakome.", u_mark[m], ".bed"))
    input.files <- paste(all.noname.files[which(all.marks == u_mark[m])], collapse = " ")
    strain.columns[[m]] <- all.strain[which(all.marks == u_mark[m])]
    #merge.line <- paste("bedtools unionbedg -i", input.files, "-filler NA >", final.file)
    merge.line <- paste("bedtools unionbedg -i", input.files, ">", final.file)
    if(!file.exists(final.file)){
        system(merge.line)
    }
}

```

Merge the results so that overlapping peaks are merged into one.
Use the mean to summarize the merged peaks

```{r merge_result}
combined.bed <- list.files(here("Results", "Peakome"), pattern = "combined", full.name = TRUE)
for(i in 1:length(combined.bed)){
    merged.file <- gsub("combined", "merged", combined.bed[i])
    if(!file.exists(merged.file)){
        #read in a few lines of the original file
        test.bed <- read.table(combined.bed[i], nrows = 10)
        op.col <- paste(3:ncol(test.bed), collapse = ",")
        merge.line <- paste("bedtools merge -i", combined.bed[i], "-c", op.col, "-o sum -d 1000 >", merged.file)
        system(merge.line)
        #remove the large combined file
        #unlink(combined.bed[i])
    }
}
```



```{bash intersect, eval = FALSE}
#filter the combined peak files to just regions overlapping genes.

bedpath=/Users/atyler/Documents/Projects/Epigenetics/Epigenetics_Manuscript/Results/peakome
genefile=/Users/atyler/Documents/Projects/Epigenetics/Epigenetics_Manuscript/Data/peakome/gene_coords.bed

for x in $(find "$bedpath" -name 'merged.peakome*'); do
    echo ": $x"
    targetfile="${x%bed}genes.bed";
    echo "$targetfile";
    bedtools intersect -a $x -b $genefile > $targetfile
done
```

The following plot shows the merged region for the same region specified above.

```{r compare_merge}
merge.files <- get.files(here("Results", "peakome"), want = c("merged", "genes"), full.names = TRUE)
merged.tables <- vector(mode = "list", length = length(merge.files))
names(merged.tables) <- gsub(".bed", "", gsub("merged.peakome.", "", basename(merge.files)))

for(i in 1:length(merge.files)){
    pdf.file <- here("Results", "peakome", gsub("peakome", "region", (gsub("bed", "pdf", basename(merge.files[i])))))
    merged.tables[[i]] <- plot_combined_bed(merge.files[i], chr = chr, start.bp = start.bp, 
    end.bp = end.bp, bp.buffer = bp.buffer, col = strain.col, 
    value.start = 5, filename = pdf.file, label.names = all.ind[which(all.marks == u_mark[i])])
}

test.file <- here("Data", "peakome", "H3K4me1_MACS_Narrow5_consOnly_counts.bed")
test.file <- here("Data", "peakome", "H3K4me3_MACS_Narrow5_consOnly_counts.bed")
plot_combined_bed(test.file, chr = chr, start.bp = start.bp, 
    end.bp = end.bp, bp.buffer = bp.buffer, col = strain.col, 
    value.start = 5, filename = "~/Desktop/test.H3K4me3.pdf", 
    label.names = all.ind[which(all.marks == u_mark[i])])

test.bed <- read.table(test.file, stringsAsFactors = FALSE)
just.peaks <- test.bed[,4:ncol(test.bed)]

logn <- log2(just.peaks+1)
col.cent <- apply(logn, 2, function(x) x - median(x))
row.cent <- apply(med.cent, 1, function(x) x - mean(x))

plot.decomp(row.cent, cols = strain.col)
```



```{r decomposition}
merged.bed <- get.files(here("Results", "Peakome"), want = c("merged", "genes"), dont.want = "pdf", full.name = TRUE)
ordered.marks <- gsub(".genes", "", gsub(".bed", "", gsub("merged.peakome.", "", basename(merged.bed))))
mark.pc <- vector(mode = "list", length = length(ordered.marks))
names(mark.pc) <- ordered.marks

decomp.file <- here("Results", "peakome", "Mark.Decomposition.by.Strain.RDS")

if(!file.exists(decomp.file)){
    for(i in 1:length(merged.bed)){
        mark.peakome <- read.table(merged.bed[i], stringsAsFactors = FALSE)
        just.peaks <- mark.peakome[,5:ncol(mark.peakome)]
        colnames(just.peaks) <- all.ind[which(all.marks == ordered.marks[i])]
        strain.cols <- col.table[match(all.strain[which(all.marks == ordered.marks[i])], col.table[,6]),3]
        peak.decomp <- plot.decomp(t(just.peaks), cols = strain.cols, main = ordered.marks[i], plot.results = TRUE)
        #save just the decomposition by individual
        strain.pc <- peak.decomp$u
        rownames(strain.pc) <- all.ind[which(all.marks == ordered.marks[i])]
        var.exp <- round(peak.decomp$var.exp*100, 1)[1:ncol(strain.pc)]
        colnames(strain.pc) <- paste0("PC", 1:ncol(strain.pc), " (", var.exp, "%)")
        mark.pc[[i]] <- strain.pc
    }
    saveRDS(mark.pc, decomp.file)
}else{
    mark.pc <- readRDS(decomp.file)
}
```

```{r plot_decomposition}
par(mfrow = c(2,2))
for(i in 1:length(mark.pc)){
    ind.strain <- all.strain[match(rownames(mark.pc[[i]]), all.ind)]
    strain.cols <- col.table[match(ind.strain, col.table[,6]),3]
    plot(mark.pc[[i]], pch = 16, col = strain.cols, main = names(mark.pc)[i])
}
```