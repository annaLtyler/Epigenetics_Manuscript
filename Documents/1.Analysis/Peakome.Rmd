---
title: "Peakome"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document:
    code_folding: hide
    collapsed: no
    toc: yes
    toc_float: yes
---

## Introduction

The purpose of this workflow is to decompose the peakomes derived
from each histone modification to visualize clustering by strain
across the different modifications. 

I have downloaded files from: 
/projects/carter-lab/hepatocytes/old/results/peakome/diffbind/


```{r set_param}
library(here)
```

```{r source_code}
all.code.dir <- list.files(here("Code"), full.names = TRUE)
for(i in 1:length(all.code.dir)){
	all.fun <- list.files(all.code.dir[i], full.names = TRUE, pattern = ".R")
	for(j in 1:length(all.fun)){source(all.fun[j])}
}
```


Read in data.


```{r data}
key.file <- here("Data", "support_files", "strain.color.table.txt") #generated by hand
col.table <- as.matrix(read.table(key.file, sep = "\t", comment.char = "%", 
    stringsAsFactors = FALSE))

peakome.files <- get.files(here("Data", "peakome"), want = "bed", dont.want = "Broad", full.names = TRUE)
peakomes <- lapply(peakome.files, read.table)
names(peakomes) <- sapply(strsplit(basename(peakome.files), "_"), function(x) x[1])

#read analysis files for meta data
analysis.files <- list.files(here("Data", "peakome"), pattern = "analysis", full.names = TRUE)
analysis.data <- lapply(analysis.files, readRDS)
samples <- lapply(analysis.data, function(x) x$samples$SampleID)

get_sample_col <- function(sample.ids){
    sample.idx <- lapply(col.table[,6], function(x) grep(x, sample.ids))
    sample.col <- lapply(1:length(sample.idx), function(x) rep(col.table[x,3], length(sample.idx[[x]])))
    sample.order <- unlist(sample.idx)
    sample.col <- unlist(sample.col)[sample.order]
    #barplot(rep(1, length(sample.col)), col = sample.col)
    return(sample.col)
}

sample.colors <- lapply(samples, get_sample_col)
```

We log2 transform, median normalize across samples and mean center 
across peaks.

```{r normalize_data}
norm_fun <- function(bed.table){
    logn <- log2(bed.table[,4:ncol(bed.table)]+1)
    col.cent <- apply(logn, 2, function(x) x - median(x))
    row.cent <- t(apply(col.cent, 1, function(x) x - mean(x)))
    return(row.cent)
}

norm.peakomes <- lapply(peakomes, norm_fun)
```

Plot the decompositions of the normalized data.

```{r plot_decomp, fig.width = 5, fig.height = 5}
all.decomp <- vector(mode = "list", length = length(norm.peakomes))
names(all.decomp) <- names(norm.peakomes)

for(i in 1:length(norm.peakomes)){
    peak.decomp <- plot.decomp(t(norm.peakomes[[i]]), mean.center = FALSE, scale.col = FALSE, 
    cols = sample.colors[[i]], main = names(norm.peakomes)[i])
    strain.pc <- peak.decomp$u
    var.exp <- round(peak.decomp$var.exp*100, 1)[1:ncol(strain.pc)]
    rownames(strain.pc) <- samples[[i]]
    colnames(strain.pc) <- paste0("PC", 1:ncol(strain.pc), " (", var.exp, "%)")
    all.decomp[[i]] <- strain.pc
}
saveRDS(all.decomp, here("Results", "peakome", "Histone.Decomposition.by.Strain.RDS"))
```

